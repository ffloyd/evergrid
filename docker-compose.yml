version: '2'

volumes:
  rails-bundle:
    driver: local
  rails-public:
    driver: local
  postgres-data:
    driver: local
  logs:
    driver: local

services:
  db:

    # use the preferred version of the official Postgres image
    # see https://hub.docker.com/_/postgres/
    image: postgres:9.4.5

    # persist the database between containers by storing it in a volume
    volumes:
      - postgres-data:/var/lib/postgresql/data

  rails:
    build: ./evergrid_rails

    env_file: .env

    environment:
      RAILS_ENV: production
      BUNDLE_WITHOUT: development:test

    volumes:
      - rails-bundle:/bundle
      - rails-public:/evergrid_rails/public
      - logs:/evergrid_rails/log

    command: ./start.sh

    expose:
      - "3000"

    links:
      - db

  # reverse proxy
  nginx:

    # set the build context to the root of the Rails app
    build: ./nginx

    # makes the web container aware of the app container
    links:
      - rails

    # use app code and precompiled assets from app container
    volumes:
      - rails-public:/evergrid_rails/public:ro
      - logs:/evergrid_rails/log

    # expose the port we configured Nginx to bind to
    ports:
      - "80:80"
